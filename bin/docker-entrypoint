#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare
fi

# If running foreman (production deployment), prepare databases
if [[ "$*" == *"foreman"* ]]; then
  echo "ðŸš€ Setting up Ragtime databases for production..."

  # Prepare all databases (creates and migrates if needed)
  ./bin/rails db:prepare RAILS_ENV=production

  # Initialize vec_chunks virtual table
  # This must happen after migrations but before app starts
  echo "ðŸ”§ Initializing vec_chunks virtual table..."
  ./bin/rails runner -e production '
    puts "ðŸ—‘ï¸  Dropping all vec_chunks related tables..."

    # List of all possible shadow tables created by sqlite-vec
    shadow_tables = [
      "vec_chunks",
      "vec_chunks_info",
      "vec_chunks_data",
      "vec_chunks_config",
      "vec_chunks_chunks",
      "vec_chunks_rowids",
      "vec_chunks_vector_chunks00"
    ]

    # Drop each table if it exists
    shadow_tables.each do |table|
      begin
        ActiveRecord::Base.connection.execute("DROP TABLE IF EXISTS #{table}")
        puts "   Dropped: #{table}"
      rescue => e
        # Table might not exist, thats ok
      end
    end

    puts ""
    puts "ðŸ“¦ Creating fresh vec_chunks virtual table..."

    # Create the virtual table with 1536 dimensions (OpenAI embeddings)
    ActiveRecord::Base.connection.execute(<<-SQL)
      CREATE VIRTUAL TABLE vec_chunks USING vec0(
        chunk_id INTEGER PRIMARY KEY,
        embedding FLOAT[1536]
      );
    SQL

    puts "âœ… vec_chunks table created successfully"
    puts ""
    puts "ðŸ“¦ Repopulating vec_chunks from existing chunks..."

    # Repopulate vec_chunks with embeddings from existing chunks
    count = 0
    Chunk.where.not(embedding: nil).find_each do |chunk|
      chunk.send(:insert_into_vec_table)
      count += 1
    end

    puts "âœ… Repopulated #{count} chunks into vec_chunks"
  ' 2>&1 | grep -v "sqlite-vec extension loaded" || true

  # Seed models (idempotent - safe to run multiple times)
  echo "ðŸ“¦ Seeding models..."
  ./bin/rails db:seed RAILS_ENV=production

  echo "âœ… Database setup complete!"
fi

exec "${@}"
