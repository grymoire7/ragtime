# Nginx configuration for Ragtime production deployment
# Serves Vue.js SPA with proper client-side routing support
# Proxies API requests to Rails via Puma Unix socket

# Upstream configuration for Puma Unix socket
upstream puma {
    server unix:///app/tmp/sockets/puma.sock fail_timeout=0;
}

server {
    listen 80;
    server_name localhost;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Health check endpoint (don't log, don't proxy)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Frontend SPA routing - serve static files or fallback to index.html
    # This handles Vue Router client-side routes (e.g., /frontend/login, /frontend/documents)
    location /frontend/ {
        alias /rails/public/frontend/;
        try_files $uri $uri/ /frontend/index.html;

        # Don't cache HTML files (so Vue Router updates work)
        location ~ \.html$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }

        # Cache static assets aggressively
        location ~ \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Frontend assets (Vite build output)
    location /assets/ {
        alias /rails/public/frontend/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Frontend icon
    location /vite.svg {
        alias /rails/public/frontend/vite.svg;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API routes - proxy to Rails with /api prefix stripped
    location /api/ {
        proxy_pass http://puma;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Proxy "";
        proxy_redirect off;

        # Remove /api prefix when proxying to Rails
        rewrite ^/api/?(.*)$ /$1 break;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Rails static assets (404s, error pages, etc.)
    location / {
        root /rails/public;
        try_files $uri @rails;
    }

    # Rails application fallback
    location @rails {
        proxy_pass http://puma;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Proxy "";
        proxy_redirect off;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
