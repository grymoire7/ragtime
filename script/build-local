#!/bin/bash
# Build the local Docker container for Ragtime
# Usage: script/build-local [--no-cache]

set -e

echo "ðŸ”¨ Building Ragtime Docker container for local testing..."

# Check for --no-cache flag
BUILD_ARGS="--platform linux/amd64 --load -t ragtime:latest"
if [[ "$*" == *"--no-cache"* ]]; then
  echo "ðŸ—‘ï¸  Building without cache..."
  BUILD_ARGS="$BUILD_ARGS --no-cache"
fi

# Build the container with proper platform for local testing
docker-buildx build $BUILD_ARGS .

echo "âœ… Build complete!"
echo ""
echo "To run the container:"
echo "  script/run-local"
echo ""
echo "Or run manually:"
echo "  docker rm ragtime-test 2>/dev/null || true"
echo "  docker run -d --name ragtime-test -p 8080:80 -e RAILS_ENV=production -e RAILS_MASTER_KEY=\$(cat config/credentials/production.key) ragtime:latest"