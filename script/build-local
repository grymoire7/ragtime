#!/bin/bash
# Build the local Docker container for Ragtime
# Usage: script/build-local [--no-cache] [--help]

set -e

# Show help message
show_help() {
  cat << EOF
ðŸ”¨ Ragtime Docker Build Script

Build the Ragtime Docker container for local testing.

USAGE:
  script/build-local [OPTIONS]

OPTIONS:
  --no-cache    Build without using Docker cache (forces clean rebuild)
  --help, -h    Show this help message

EXAMPLES:
  script/build-local           # Normal build with cache
  script/build-local --no-cache # Force clean rebuild

The container will be tagged as 'ragtime:latest' and built for
linux/amd64 platform to ensure compatibility across environments.
EOF
}

# Parse arguments
BUILD_ARGS="--platform linux/amd64 --load -t ragtime:latest"
for arg in "$@"; do
  case $arg in
    --help|-h)
      show_help
      exit 0
      ;;
    --no-cache)
      echo "ðŸ—‘ï¸  Building without cache..."
      BUILD_ARGS="$BUILD_ARGS --no-cache"
      ;;
    *)
      echo "âŒ Unknown option: $arg"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

echo "ðŸ”¨ Building Ragtime Docker container for local testing..."

# Build the container with proper platform for local testing
docker-buildx build $BUILD_ARGS .

echo "âœ… Build complete!"
echo ""
echo "To run the container:"
echo "  script/run-local"
echo ""
echo "Or run manually:"
echo "  docker rm ragtime-test 2>/dev/null || true"
echo "  docker run -d --name ragtime-test -p 8080:80 -e RAILS_ENV=production -e RAILS_MASTER_KEY=\$(cat config/credentials/production.key) ragtime:latest"