#!/bin/bash
# Run the local Ragtime Docker container
# Usage: script/run-local [--help]

set -e

# Show help message
show_help() {
  cat << EOF
üöÄ Ragtime Docker Run Script

Start the Ragtime Docker container locally on port 8080.

USAGE:
  script/run-local [OPTIONS]

OPTIONS:
  --help, -h    Show this help message

REQUIREMENTS:
  - config/credentials/production.key must exist
  - Docker must be running

EXAMPLE:
  script/run-local

The script will:
  1. Verify production credentials exist
  2. Remove any existing 'ragtime-test' container
  3. Start a new container with production environment
  4. Map port 8080:80 for web access
  5. Set RAILS_MASTER_KEY from credentials file

ACCESS:
  Application: http://localhost:8080
  Container logs: docker logs ragtime-test
  Stop container: docker stop ragtime-test
EOF
}

# Parse arguments
for arg in "$@"; do
  case $arg in
    --help|-h)
      show_help
      exit 0
      ;;
    *)
      echo "‚ùå Unknown option: $arg"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

echo "üöÄ Starting Ragtime container for local testing..."

# Check if production credentials exist
if [ ! -f "config/credentials/production.key" ]; then
    echo "‚ùå Error: config/credentials/production.key not found"
    echo "Please ensure the production credentials file exists before running the container."
    exit 1
fi

# Remove existing container if it exists
echo "üóëÔ∏è  Removing existing container..."
docker rm ragtime-test 2>/dev/null || true

# Run the new container
echo "üèÉ Starting new container..."
CONTAINER_ID=$(docker run -d --name ragtime-test -p 8080:80 -e RAILS_ENV=production -e RAILS_MASTER_KEY=$(cat config/credentials/production.key) ragtime:latest)

echo "‚úÖ Container started!"
echo ""
echo "Container details:"
echo "  Name: ragtime-test"
echo "  ID: $CONTAINER_ID"
echo "  URL: http://localhost:8080"
echo ""
echo "To view logs:"
echo "  docker logs ragtime-test"
echo ""
echo "To follow logs:"
echo "  docker logs -f ragtime-test"
echo ""
echo "To stop the container:"
echo "  docker stop ragtime-test"
echo ""
echo "To rebuild and run:"
echo "  script/build-local && script/run-local"